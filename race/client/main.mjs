import * as alt from 'alt';
import * as native from 'natives';

let time = 0;
let correndo = false;
let corrida = {locs:[{x: 0, y: 0, z: 0 }]};
let cds = 0;
let blip = null;
var race = [
	{
        time: 265, 
        locs : [
            {x: 165.61, y: -1971.98, z: 18.12 },
            {x: 436.74, y: -2121.32, z: 19.62 },
            {x: 821.94, y: -1871.34, z: 28.69 },
            {x: 1269.87, y: -1662.22, z: 46.72 },
            {x: 1167.91, y: -1010.36, z: 44.15 },
            {x: 169.37, y: -1019.16, z: 28.75 },
            {x: 190.38, y: -770.57, z: 31.78 },
            {x: 91.02, y: -638.16, z: 31.01 },
            {x: 15.47, y: -337.53, z: 42.98 },
            {x: -315.46, y: -179.68, z: 38.90 },
            {x: -407.52, y: -56.98, z: 44.37 },
            {x: -617.12, y: 268.80, z: 81.12 },
            {x: -1005.33, y: 271.99, z: 66.08 },
            {x: -695.31, y: -364.62, z: 33.80 },
            {x: -643.20, y: -768.60, z: 24.98 },
            {x: -71.02, y: -1030.23, z: 28.02 },
            {x: -74.73, y: -1262.74, z: 28.99 }
        ]
	},
	{
        time: 165,
        locs : [
            {x: 138.75, y: -1569.08, z: 28.75 },
            {x: 262.13, y: -937.15, z: 28.72 },
            {x: 111.79, y: -792.34, z: 30.82 },
            {x: -186.00, y: -1301.69, z: 30.66 },
            {x: -407.36, y: -1744.18, z: 19.36 },
            {x: -178.89, y: -1790.34, z: 29.26 },
            {x: 129.59, y: -1875.25, z: 23.31 },
            {x: 513.65, y: -1594.59, z: 28.67 },
            {x: 500.92, y: -1012.51, z: 27.38 },
            {x: 406.14, y: -881.92, z: 28.82 },
            {x: 118.88, y: -941.65, z: 29.13 },
            {x: 203.68, y: -1087.45, z: 28.70 },
            {x: 30.25, y: -1305.83, z: 29.17 }
        ]
	},
	{
        time: 190,
        locs : [
            {x: 214.15, y: -1419.41, z: 28.70 },
            {x: 154.71, y: -1012.99, z: 28.76 },
            {x: -550.31, y: -831.70, z: 27.69 },
            {x: -625.90, y: -449.84, z: 34.18 },
            {x: -1341.41, y: -49.03, z: 50.42 },
            {x: -1668.49, y: -479.43, z: 37.85 },
            {x: -1932.74, y: -436.20, z: 19.35 },
            {x: -1935.61, y: -513.14, z: 11.21 },
            {x: -1265.27, y: -733.15, z: 10.45 },
            {x: -687.11, y: -554.89, z: 33.51 },
            {x: -575.23, y: -836.39, z: 25.89 },
            {x: -72.89, y: -1035.51, z: 27.63 },
            {x: -304.76, y: -1259.75, z: 29.96 }
        ]
	},
	{
        time: 205,
        locs : [
            {x: 480.59, y: -1660.33, z: 28.65 },
            {x: 434.92, y: -1860.17, z: 26.93 },
            {x: 658.88, y: -2062.74, z: 28.69 },
            {x: 828.93, y: -1831.54, z: 28.53 },
            {x: 423.23, y: -1589.83, z: 28.70 },
            {x: 449.56, y: -1447.40, z: 28.71 },
            {x: 503.66, y: -771.21, z: 24.27 },
            {x: 200.97, y: -599.41, z: 28.72 },
            {x: -4.09, y: -873.96, z: 29.60 },
            {x: 678.26, y: -1021.00, z: 34.71 },
            {x: 565.80, y: -345.86, z: 42.97 },
            {x: 260.11, y: -564.07, z: 42.68 },
            {x: 84.17, y: -604.58, z: 43.63 },
            {x: -156.91, y: -699.22, z: 37.26 },
            {x: -264.28, y: -792.08, z: 31.61 },
            {x: -110.73, y: -924.80, z: 28.70 },
            {x: -81.27, y: -1058.17, z: 26.89 },
            {x: -142.20, y: -1352.27, z: 29.57 }
        ]
	},
	{
        time: 205,
        locs : [
            {x: 519.49, y: -1587.41, z: 28.65 },
            {x: 310.50, y: -1299.87, z: 30.65 },
            {x: 165.21, y: -1017.49, z: 28.75 },
            {x: -29.67, y: -1133.60, z: 26.11 },
            {x: 162.81, y: -411.53, z: 40.51 },
            {x: -38.10, y: -248.99, z: 45.42 },
            {x: -53.22, y: -28.83, z: 65.98 },
            {x: -484.34, y: 132.44, z: 63.17 },
            {x: -557.28, y: -16.91, z: 43.38 },
            {x: -231.27, y: -585.64, z: 33.81 },
            {x: 225.79, y: -845.90, z: 29.60 },
            {x: 191.65, y: -1330.94, z: 28.71 },
            {x: 70.44, y: -1212.79, z: 28.70 },
            {x: 29.45, y: -1037.63, z: 29.34 }
        ]
	},
	{
        time: 212,
        locs : [
            {x: 335.14, y: -1712.75, z: 28.68 },
            {x: 211.85, y: -1606.84, z: 28.54 },
            {x: 307.73, y: -1505.671, z: 28.51 },
            {x: 97.531, y: -1332.79, z: 28.69 },
            {x: 96.705, y: -1021.18, z: 28.76 },
            {x: -9.74, y: -947.58, z: 28.75 },
            {x: 184.54, y: -353.73, z: 43.48 },
            {x: 40.72, y: -278.16, z: 46.89 },
            {x: 49.153, y: -237.45, z: 48.81 },
            {x: -84.20, y: -181.99, z: 49.06 },
            {x: 33.56, y: 246.48, z: 108.96 },
            {x: 230.57, y: 440.72, z: 119.76 },
            {x: 316.76, y: 992.26, z: 209.92 },
            {x: -143.84, y: 1048.17, z: 229.60 },
            {x: -122.93, y: 935.41, z: 235.24 },
            {x: -111.19, y: 870.90, z: 235.13 },
            {x: -72.76, y: 866.09, z: 235.03 },
            {x: -98.95, y: 915.78, z: 235.07 },
            {x: -153.01, y: 1038.41, z: 230.28 },
            {x: -329.28, y: 971.33, z: 232.70 },
            {x: -619.83, y: 993.42, z: 239.65 },
            {x: -714.96, y: 989.09, z: 237.39 },
            {x: -576.16, y: 849.85, z: 203.47 },
            {x: -530.44, y: 667.84, z: 141.80 },
            {x: -551.12, y: 523.79, z: 106.84 },
            {x: -537.13, y: 282.52, z: 82.41 },
            {x: -552.993, y: 15.41, z: 43.78 },
            {x: -530.88, y: -28.67, z: 43.84 }
        ]
	},
	{
        time: 240,
        locs : [
            {x: 335.53, y: -1717.67, z: 28.77 },
            {x: 507.43, y: -1892.27, z: 24.95 },
            {x: 604.60, y: -1608.22, z: 25.22 },
            {x: 526.46, y: -1482.61, z: 28.70 },
            {x: 285.75, y: -1298.87, z: 29.38 },
            {x: 219.73, y: -1098.54, z: 28.66 },
            {x: 343.99, y: -707.56, z: 28.66 },
            {x: 870.30, y: 119.34, z: 70.41 },
            {x: 1131.37, y: 373.74, z: 90.85 },
            {x: 1017.07, y: 495.74, z: 96.69 },
            {x: 768.10, y: 614.87, z: 125.13 },
            {x: 658.10, y: 654.93, z: 128.25 },
            {x: 600.13, y: 617.46, z: 128.26 },
            {x: 635.97, y: 596.89, z: 128.26 },
            {x: 657.17, y: 632.51, z: 128.26 },
            {x: 821.21, y: 558.95, z: 125.12 },
            {x: 904.07, y: 527.47, z: 121.61 },
            {x: 675.62, y: 345.10, z: 110.47 },
            {x: 467.15, y: 399.42, z: 138.41 },
            {x: 285.62, y: 606.71, z: 153.76 },
            {x: 240.28, y: 458.70, z: 122.54 },
            {x: 261.20, y: 351.30, z: 104.82 },
            {x: 121.71, y: -33.15, z: 67.06 },
            {x: -100.80, y: -650.59, z: 35.54 },
            {x: -226.56, y: -665.89, z: 32.81 },
            {x: -336.06, y: -687.58, z: 32.29 },
            {x: -353.86, y: -821.96, z: 30.84 },
            {x: -356.24, y: -951.80, z: 30.43 },
            {x: -244.01, y: -999.57, z: 28.45 },
            {x: -278.71, y: -1398.89, z: 30.69 },
            {x: -135.36, y: -1526.19, z: 33.64 },
            {x: -75.55, y: -1460.27, z: 31.47 },
            {x: -90.29, y: -1420.95, z: 28.99 }
        ]
	},
    {
        time: 146,
        locs : [
            {x: 334.08, y: -1719.05, z: 28.76 },
            {x: 408.66, y: -1720.89, z: 28.67 },
            {x: 492.98, y: -1669.86, z: 28.67 },
            {x: 798.41, y: -1751.14, z: 28.72 },
            {x: 734.75, y: -2361.08, z: 22.63 },
            {x: 601.17, y: -2513.41, z: 16.15 },
            {x: 556.09, y: -2550.93, z: 5.69 },
            {x: 350.77, y: -2500.41, z: 5.52 },
            {x: 358.15, y: -2251.83, z: 9.53 },
            {x: 282.89, y: -2116.57, z: 15.31 },
            {x: -59.49, y: -2052.72, z: 20.75 },
            {x: -332.87, y: -2085.31, z: 23.21 },
            {x: -453.01, y: -1972.26, z: 24.03 },
            {x: -404.36, y: -1845.52, z: 20.07 },
            {x: -396.20, y: -1748.66, z: 19.462 },
            {x: -368.95, y: -1527.77, z: 27.15 }
        ]
	},
	{
        time:248,
        locs : [
            {x: 312.00668334961, y: -1699.2014160156, z: 28.779430389404 },
            {x: 156.74221801758, y: -1580.3131103516, z: 28.62646484375 },
            {x: 52.918167114258, y: -1529.9681396484, z: 28.66160774231 },
            {x: -83.792846679688, y: -1546.2673339844, z: 32.223373413086 },
            {x: -274.45797729492, y: -1329.8239746094, z: 30.702571868896 },
            {x: -219.85069274902, y: -995.47534179688, z: 28.692695617676 },
            {x: -17.976902008057, y: -435.12915039063, z: 39.620025634766 },
            {x: 67.302551269531, y: -184.94274902344, z: 54.414127349854 },
            {x: -390.11547851563, y: 15.223469734192, z: 46.294734954834 },
            {x: -419.25457763672, y: 126.94961547852, z: 64.515007019043 },
            {x: -543.90631103516, y: 160.68032836914, z: 64.779312133789 },
            {x: -532.65814208984, y: 402.06085205078, z: 89.967193603516 },
            {x: -556.76879882813, y: 515.01458740234, z: 105.37133789063 },
            {x: -660.78723144531, y: 697.14575195313, z: 152.48545837402 },
            {x: -615.68353271484, y: 743.01544189453, z: 179.6968536377 },
            {x: -745.65771484375, y: 828.72039794922, z: 213.45672607422 },
            {x: -722.67095947266, y: 979.42010498047, z: 237.32257080078 },
            {x: -1145.4665527344, y: 1060.8980712891, z: 207.53410339355 },
            {x: -1429.0686035156, y: 780.94903564453, z: 182.61657714844 },
            {x: -1641.5283203125, y: 993.21044921875, z: 152.14254760742 },
            {x: -1901.5368652344, y: 696.42901611328, z: 126.93069458008 },
            {x: -1815.3326416016, y: 95.858512878418, z: 72.823692321777 },
            {x: -2029.482421875, y: 170.49897766113, z: 109.72478485107 },
            {x: -2301.7465820313, y: 482.11004638672, z: 173.58128356934 },
            {x: -2318.5031738281, y: 392.33163452148, z: 173.83757019043 }
        ]
	},
	{
        time: 420,
        locs : [
            {x: 339.56, y: -1719.29, z: 28.71 },
            {x: 313.45, y: -1793.44, z: 27.38 },
            {x: 295.41, y: -1891.57, z: 26.33 },
            {x: 536.76, y: -2052.76, z: 27.44 },
            {x: 757.82, y: -2112.98, z: 28.68 },
            {x: 719.81, y: -3057.27, z: 12.09 },
            {x: 1077.40, y: -3330.07, z: 5.257 },
            {x: 1187.41, y: -3219.88, z: 5.157 },
            {x: 1258.51, y: -3191.76, z: 5.157 },
            {x: 1239.42, y: -3091.44, z: 5.16 },
            {x: 1144.02, y: -3115.09, z: 5.14 },
            {x: 1077.44, y: -3125.69, z: 5.26 },
            {x: 1077.44, y: -3209.89, z: 5.24 },
            {x: 981.33, y: -3222.91, z: 5.26 },
            {x: 981.52, y: -3119.21, z: 5.27 },
            {x: 928.98, y: -2946.54, z: 5.25 },
            {x: 864.60, y: -3006.78, z: 5.27 },
            {x: 869.02, y: -2958.79, z: 5.27 },
            {x: 896.95, y: -3005.09, z: 5.27 },
            {x: 977.43, y: -3030.68, z: 5.26 },
            {x: 876.14, y: -3062.40, z: 5.24 },
            {x: 807.89, y: -3109.58, z: 5.25 },
            {x: 866.58, y: -3112.85, z: 5.27 },
            {x: 781.83, y: -3089.05, z: 5.15 },
            {x: 719.272, y: -2543.05, z: 19.21 },
            {x: 348.837, y: -2500.62, z: 5.46 },
            {x: 356.762, y: -2191.65, z: 12.38 },
            {x: 116.549, y: -2035.80, z: 17.69 },
            {x: -150.89, y: -2087.29, z: 25.10 },
            {x: -399.19, y: -2099.14, z: 25.62 },
            {x: -615.96, y: -2086.53, z: 20.96 },
            {x: -742.43, y: -2168.27, z: 13.68 },
            {x: -828.43, y: -2225.37, z: 16.74 },
            {x: -1083.1, y: -2596.95, z: 19.50 },
            {x: -960.21, y: -2741.21, z: 19.48 },
            {x: -892.78, y: -2686.25, z: 19.52 },
            {x: -796.41, y: -2523.53, z: 13.11 },
            {x: -660.55, y: -2323.38, z: 8.86 },
            {x: -515.54, y: -2121.20, z: 8.44 },
            {x: -798.85, y: -1989.93, z: 8.54 },
            {x: -964.62, y: -2142.89, z: 8.12 },
            {x: -1049.5, y: -1912.78, z: 12.43 },
            {x: -904.74, y: -1765.00, z: 18.71 },
            {x: -807.23, y: -1661.60, z: 16.12 },
            {x: -675.59, y: -1469.46, z: 9.845 },
            {x: -543.97, y: -1164.19, z: 18.42 },
            {x: -511.73, y: -914.69, z: 24.99 },
            {x: -543.28, y: -685.141, z: 32.62 },
            {x: -676.25, y: -356.439, z: 34.00 },
            {x: -997.75, y: -233.412, z: 37.04 },
            {x: -1393.34, y: -389.99, z: 36.03 },
            {x: -1512.93, y: -385.04, z: 40.63 },
            {x: -1529.08, y: -298.27, z: 48.07 },
            {x: -1422.66, y: -179.78, z: 46.85 },
            {x: -1376.62, y: -67.56, z: 51.56 },
            {x: -1165.39, y: -137.64, z: 39.06 },
            {x: -922.89, y: -137.69, z: 37.11 },
            {x: -614.51, y: -9.60, z: 42.00 },
            {x: -327.01, y: -28.98, z: 47.39 },
            {x: -290.85, y: -209.46, z: 37.40 },
            {x: -281.70, y: -334.46, z: 29.36 },
            {x: -231.29, y: -571.77, z: 33.91 },
            {x: -349.05, y: -711.85, z: 32.52 },
            {x: -350.51, y: -755.03, z: 33.32 }
        ]
	}
]

alt.on('keydown', (key) => {
	let scriptID = alt.Player.local.scriptID;
	let pedPos = native.getEntityCoords(scriptID, true);
	let dist = distance({x:385.29, y:-1657.45, z:27.30}, pedPos);
	if(key == 69 && dist < 8 && !correndo && native.isPedInAnyVehicle(scriptID, true)) {
        correndo = true;
        corrida = race[Math.floor(race.length * Math.random())];	
		time = corrida.time;
		blip = CriandoBlip(corrida.locs[cds]);
		alt.emit('notify', 'sucess', 'Atenção', 'Corrida Iniciada')
	}
});

alt.everyTick( async () => {  
    let scriptID = alt.Player.local.scriptID;
	let pedPos = native.getEntityCoords(scriptID, true);
	let dist = distance({x:385.29, y:-1657.45, z:27.30}, pedPos);
	if (dist < 10 && !correndo && native.isPedInAnyVehicle(scriptID, true)) {    
        drawMarker({x:385.29, y:-1657.45, z:27.30})
		if (dist < 7) {
            drawText("PRESSIONE  ~r~E~w~  PARA INICIAR A CORRIDA",0.5,0.93,0.50,255,255,255,180)	
		}		
	}
});

alt.everyTick( async () => {  
    let scriptID = alt.Player.local.scriptID;
    let pedPos = native.getEntityCoords(scriptID, true);
    let dist = distance(corrida.locs[cds], pedPos);
    if (dist < 70 && time > 0 && correndo) { 
        if (cds == corrida.locs.length - 1) {   
            drawMarker3(corrida.locs[cds])
        } else {
            drawMarker2(corrida.locs[cds])
        }
        if (dist < 7) {
            native.removeBlip(blip)
            if (cds != corrida.locs.length -1) {
                cds++	
                blip = CriandoBlip(corrida.locs[cds]);
            } else {
		        alt.emit('notify', 'sucess', 'Aviso', 'Venceu roludo')
                cds = 0
                time = -1
                corrida = {locs:[{x: 0, y: 0, z: 0 }]}
                correndo = false
            }
        }
    }
});


function drawMarker(pos) {
	native.drawMarker(1,pos.x,pos.y,pos.z-1.2,0,0,0,0.0,0,0,10.5,10.5,1.5,255,255,0,50,0,0,0,1)
};
function drawMarker2(pos) {
	native.drawMarker(2,pos.x,pos.y,pos.z+1.2,0,0,0,0.0,0,0,2.5,2.5,2.4,0,0,255,50,0,0,0,1)
};
function drawMarker3(pos) {
	native.drawMarker(4,pos.x,pos.y,pos.z+1.2,0,0,0,0.0,0,0,5.5,5.5,5.4,255,255,255,50,0,0,0,1)
};

function CriandoBlip(pos){
	let blips = native.addBlipForCoord(pos.x,pos.y,pos.z)
	native.setBlipSprite(blips,1)
	native.setBlipColour(blips,5)
	native.setBlipScale(blips,0.4)
	native.setBlipAsShortRange(blips,false)
	native.setBlipRoute(blips,true)
	native.beginTextCommandSetBlipName("STRING")
	native.endTextCommandSetBlipName(blips)
	return blips;
}

function drawText(msg, x, y, scale, r, g, b, a) {
    native.beginTextCommandDisplayText('STRING');
    native.addTextComponentSubstringPlayerName(msg);
    native.setTextFont(4);
    native.setTextScale(1, scale);
    native.setTextWrap(0.0, 1.0);
    native.setTextCentre(true);
    native.setTextColour(r, g, b, a);
    native.setTextOutline();
    native.setTextDropShadow();
    native.endTextCommandDisplayText(x,y);
}

alt.setInterval(() => {
	if (time > 0) {
		time--       
		if (time == 0)  {
            correndo = false
            native.removeBlip(blip)
            corrida = {locs:[{x: 0, y: 0, z: 0 }]}
            cds = 0
		    alt.emit('notify', 'error', 'Aviso', 'Perdeu lesma fdp')
		}
	}	
},1000);

alt.everyTick( async () => {
	if (time > 0) {    
        drawText("Points ~g~"+cds+"/"+(corrida.locs.length-1)+"",0.5,0.20,0.875,255,255,255,90)	
        drawText("RESTAM ~g~"+time+" SEGUNDOS ~w~PARA CHEGAR AO DESTINO FINAL DA CORRIDA",0.5,0.905,0.45,255,255,255,100)
        drawText("VENÇA A CORRIDA E SUPERE SEUS PROPRIOS RECORDES ANTES DO TEMPO ACABAR",0.5,0.93,0.38,255,255,255,50)
	}
});

function distance(vector1, vector2) {
    if (vector1 === undefined || vector2 === undefined) {
        throw new Error('AddVector => vector1 or vector2 is undefined');
    }
    return Math.sqrt(Math.pow(vector1.x - vector2.x, 2) + Math.pow(vector1.y - vector2.y, 2) + Math.pow(vector1.z - vector2.z, 2));
};